{% extends "base.html" %}

{% block content %}
<h1>QR Code Scanner</h1>
<video id="videoElement" style="width: 100%; max-width: 500px;"></video>
<div id="output"></div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.3.1/dist/jsQR.min.js"></script>
<script>
function scanQRCode() {
    const video = document.getElementById("videoElement");
    const outputElement = document.getElementById("output");
    const canvasElement = document.createElement("canvas");
    const canvas = canvasElement.getContext("2d");

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(function(stream) {
            video.srcObject = stream;
            video.setAttribute("playsinline", true);
            video.play();
            requestAnimationFrame(tick);
        });

    function tick() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvasElement.height = video.videoHeight;
            canvasElement.width = video.videoWidth;
            canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
            var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
            var code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });
            if (code) {
                outputElement.textContent = "QR Code detected. Fetching student information...";
                sendQRCodeToServer(code.data);
                return;
            }
        }
        requestAnimationFrame(tick);
    }
}

function sendQRCodeToServer(qrData) {
    fetch('{% url "process_qr" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({qr_data: qrData})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const studentInfo = data.student_info;
            let infoHTML = `
                <h2>Student Information</h2>
                <p>Name: ${studentInfo.name}</p>
                <p>lat_scanned: ${studentInfo.last_scanned}</p>
                <p>is_scanned: ${studentInfo.is_scanned}</p>
                ${studentInfo.image
                ? `<img src="${studentInfo.image_url}" alt="Student Photo">`
                : '<p>No image available</p>'}
            `;
            document.getElementById('output').innerHTML = infoHTML;
        } else {
            document.getElementById('output').textContent = "Error: " + data.message;
        }
    })
    .catch((error) => {
        console.error('Error:', error);
        document.getElementById('output').textContent = "An error occurred while fetching student information.";
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

window.onload = scanQRCode;
</script>
{% endblock %}